# Linting & Testing Setup

This document describes the linting and testing infrastructure configured for the Qiima monorepo.

## Overview

All linting and testing tools have been installed and configured across the monorepo with shared configurations in the `config/` directory.

## Tools Installed

### Linting
- **ESLint** v9.37.0 (workspace root + all packages)
- **Prettier** v3.6.2 (workspace root)
- **TypeScript** v5.9.2 (all packages)
- **@typescript-eslint/parser** & **@typescript-eslint/eslint-plugin** v8.46.0

### Testing
- **Jest** v30.2.0 (all apps & packages)
- **ts-jest** v29.4.5 (for TypeScript packages)
- **@testing-library/react-native** v13.3.3 (mobile)
- **@testing-library/react** v16.3.0 (web)
- **@testing-library/jest-dom** v6.9.1 (web)
- **jest-expo** v54.0.12 (mobile)

## Configuration Files

### Shared Configs (in `config/`)
- `eslint-base.js` - Base ESLint configuration
- `tsconfig.base.json` - Base TypeScript settings
- `tsconfig.react-native.json` - For React Native packages (ui)
- `tsconfig.react.json` - For React web packages
- `tsconfig.lib.json` - For library packages
- `jest.base.js` - Base Jest configuration for packages

### Root Level
- `.prettierrc.js` - Prettier formatting rules
- `.prettierignore` - Files to ignore for formatting
- `turbo.json` - Turborepo task pipeline configuration

## Per-Package Setup

### Mobile App (`apps/mobile`)
- Jest with jest-expo preset
- React Native Testing Library
- ESLint with expo config
- TypeScript strict mode

**Scripts:**
```bash
pnpm --filter qiima test          # Run tests
pnpm --filter qiima test:watch    # Watch mode
pnpm --filter qiima test:coverage # With coverage
pnpm --filter qiima lint          # Lint code
pnpm --filter qiima type-check    # Type check
```

### Web App (`apps/web`)
- Jest with Next.js integration
- React Testing Library
- ESLint with Next.js config
- TypeScript strict mode

**Scripts:**
```bash
pnpm --filter web test          # Run tests
pnpm --filter web test:watch    # Watch mode
pnpm --filter web test:coverage # With coverage
pnpm --filter web lint          # Lint code
pnpm --filter web type-check    # Type check
```

### Packages (`packages/*`)

All packages (`@qiima/ui`, `@qiima/state`, `@qiima/queries`, `@qiima/utils`) have:
- Jest with ts-jest
- ESLint extending base config
- TypeScript extending appropriate base config
- Standard test/lint scripts

**Scripts (example for @qiima/ui):**
```bash
pnpm --filter @qiima/ui test       # Run tests
pnpm --filter @qiima/ui test:watch # Watch mode
pnpm --filter @qiima/ui lint       # Lint code
pnpm --filter @qiima/ui type-check # Type check
```

## Workspace-Level Commands

Run tasks across the entire monorepo using Turborepo:

```bash
# Run all tests
pnpm test

# Run all linting
pnpm lint

# Run all type checks
pnpm type-check

# Format all code
pnpm format
```

## Task Dependencies (Turbo)

The following task dependencies are configured in `turbo.json`:

- `build` depends on `^build` (upstream packages) + `type-check`
- `lint` depends on `^lint` (upstream packages)
- `test` depends on `^build` (upstream packages must be built first)
- `type-check` depends on `^build` (upstream packages)

This ensures that:
1. Packages are built in the correct order
2. Tests run against built dependencies
3. Type checking validates the full dependency graph

## Coverage Thresholds

All packages have coverage thresholds set to **70%** for:
- Branches
- Functions
- Lines
- Statements

Critical code (votes/scores/permissions) should target **â‰¥90%** coverage.

## CI/CD Integration

All tasks are cacheable by Turborepo, making CI runs fast. Recommended CI workflow:

```yaml
- pnpm install
- pnpm turbo lint
- pnpm turbo type-check
- pnpm turbo test
- pnpm turbo build
```

## ESLint Rules

Key rules configured:
- Strict TypeScript checks
- Unused variables must be prefixed with `_`
- `any` type triggers warnings
- Modern ES syntax supported

## Prettier Rules

Key formatting rules:
- Single quotes
- 2-space indentation
- Semicolons required
- 80 character line width
- Trailing commas (ES5)
- LF line endings

## Next Steps

1. Write your first tests in `__tests__/` or `*.test.ts` files
2. Run `pnpm lint` to check code style
3. Run `pnpm test` to run all tests
4. Add pre-commit hooks (optional) with husky + lint-staged
5. Set up CI/CD to run these checks on PRs

## Troubleshooting

### Peer Dependency Warnings
Some minor peer dependency warnings exist (e.g., React versions). These are non-critical and can be resolved as packages are updated.

### Jest Cache Issues
If tests behave unexpectedly, clear Jest cache:
```bash
pnpm --filter <package> test --clearCache
```

### TypeScript Errors in Tests
Ensure `@types/jest` is installed and `jest.config.js` is properly configured.
